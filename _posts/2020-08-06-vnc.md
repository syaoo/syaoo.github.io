---
title: VNC的安装与使用
tag: ['vnc']
article_header:
  type: overlay
  theme: dark
  background_color: '#203028'
  background_image:
    gradient: 'linear-gradient(135deg, rgba(34, 139, 87 , .4), rgba(139, 34, 139, .4))'
    src: /assets/images/cover2.jpg
---


玄学的VNC（可能是我太辣鸡了叭），简单记录，下次用到时或许可以直接使用Orz。
<!--more-->

## VNC的配置与使用（Centos8、Ubuntu20测试）
文中使用的vncserver都是tigervncserver，不同的VNC使用都差不多，但是在xstart文件的配置可能有所不同，而且不同的桌面环境配置也不相同，下面使用的桌面环境都是Gnome。
1. **安装tigervnc**
    ```bash
    # CentOS
    sudo dnf install tigervnc-server
    # ubuntu 
    sudo apt install tigervnc-standalone-server
    ```
2. xstarup配置
下面两个配置，第一个只保留关键部分。
配置1，在CentOs及两个Ubuntu上测试，其中一个Ubuntu灰屏
    ```
    #!/bin/sh
    unset SESSION_MANAGER
    unset DBUS_SESSION_BUS_ADDRESS
    gnome-session &

    [ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
    [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
    xsetroot -solid grey
    vncconfig -iconic &
    ```
配置2，在CentOS测试，Ubuntu未测试
    ```
    #!/bin/sh

    unset SESSION_MANAGER
    unset DBUS_SESSION_BUS_ADDRESS
    OS=`uname -s`
    if [ $OS = 'Linux' ]; then
      case "$WINDOWMANAGER" in
        *gnome*)
          if [ -e /etc/SuSE-release ]; then
            PATH=$PATH:/opt/gnome/bin
            export PATH
          fi
          ;;
      esac
    fi
    if [ -x /etc/X11/xinit/xinitrc ]; then
      exec /etc/X11/xinit/xinitrc
    fi
    if [ -f /etc/X11/xinit/xinitrc ]; then
      exec sh /etc/X11/xinit/xinitrc
    fi

    [ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
    [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
    xsetroot -solid grey
    vncconfig -iconic &
    xterm -geometry 8024+10+10 -ls -title "$VNCDESKTOP Desktop" &
    twm &
    # gnome-session &
    gnome-session gnome
    ```
可能**需要重启**后才能正常使用。
3. **vncsever使用**
   vncserver中常用的命令就是`vncserver`

   ```bash
   # 开启一个端口
   vncserver :20 # 如 :20 指定端口号为20，
   # 停止一个端口
   vncserver -kill :20
   # 其他可选参数
   vncserver :22 -localhost no # -localhost设置是否为本地端口
   vncserver :22 -xstartup ./xstartup #指定xstartup文件
   ```

   

4. **访问远程桌面**
    使用VNC客户端，输入地址+端口就可以访问。如在realvnc中`192.168.194.236:22`
    由于tigervncserver默认使用本地端口，使用其他设备不能直接访问，可以在启动时加`-localhost no`参数指定端口可以让所有设备访问。
    
    ```bash
    ## 不使用 -localhost参数
    vncserver :22
    # 查看端口开放情况
     netstat -ano | grep 5922
    tcp        0      0 127.0.0.1:5922          0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp6       0      0 ::1:5922                :::*                    LISTEN      off (0.00/0/0)
    
    ## 使用 -localhost参数
    vncserver :22 -localhost no
    # 查看端口开放情况
    netstat -ano | grep 5922
    tcp        0      0 0.0.0.0:5922            0.0.0.0:*               LISTEN      off (0.00/0/0)
    tcp6       0      0 :::5922                 :::*                    LISTEN      off (0.00/0/0)
    ```
此外还可以使用ssh端口转发，或者使用iptables或firewall-cmd开发指定端口。
如：

    ```bash
    ### ssh端口转发，访问使用127.0.0.1:5922
    ssh -L 5922:127.0.0.1:5922 -N li@192.168.194.236
    ### firewall-cmd 开放端口
    firewall-cmd --permanent --zoon=public --add-port=5901/tcp
    # 或者端口范围
    firewall-cmd --permanent --zoon=public --add-port=5900-5999/tcp
    # 生效规则
    firewall-cmd --reload
    ```

## 后记
这个VNC是真滴玄学，都是Ubuntu20，都是tigervncserver，同样的xstartup文件，可是一个就可以正常，一个就是灰屏。灰屏的那个不使用xstartup能连接，但是锁屏后就不能输入密码解锁了。

在redhat（realVNC、tigerVNC）上可用的xstartup文件，

```
#!/bin/sh

[ -r /etc/sysconfig/i18n ] && . /etc/sysconfig/i18n
export LANG
export SYSFONT
vncconfig -iconic &
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
OS=`uname -s`
if [ $OS = 'Linux' ]; then
  case "$WINDOWMANAGER" in
    *gnome*)
      if [ -e /etc/SuSE-release ]; then
        PATH=$PATH:/opt/gnome/bin
        export PATH
      fi
      ;;
  esac
fi
if [ -x /etc/X11/xinit/xinitrc ]; then
  exec /etc/X11/xinit/xinitrc
fi
if [ -f /etc/X11/xinit/xinitrc ]; then
  exec sh /etc/X11/xinit/xinitrc
fi
[ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
xsetroot -solid grey
xterm -geometry 80x24+10+10 -ls -title "$VNCDESKTOP Desktop" &
twm &
```





---

**参考**

1. [](#)

