---
title: VNC的安装与使用
tag: ['vnc']
article_header:
  type: overlay
  theme: dark
  background_color: '#203028'
  background_image:
    gradient: 'linear-gradient(135deg, rgba(34, 139, 87 , .4), rgba(139, 34, 139, .4))'
    src: /assets/images/cover2.jpg
---

玄学的VNC（可能是我太辣鸡了叭），简单记录，下次用到时或许可以直接使用Orz。服务端tigervncserver和x11vnc。对比x11vnc和tigervncserver，发现前者远程登陆与本地登陆桌面使用的是同一个环境（进程），就是你在远程与本地的操作是同步，可见的；而后者tigervncserver，本地与远程各自使用不同桌面环境（进程），远程看不到本地的操作，本地看不到远程的操作。
<!--more-->

## 使用x11vnc作为服务端（更新）

之前使用的都是tigervnc之类的作为服务端但是总是不能很顺利的安装使用，同样的配置在不同的设备可能会有不同的效果，虽然使用xrdp可以很方便的安装使用，但是xrdp有一个问题是，如果使用远程登陆桌面，本地就不能在登陆桌面，反之已然，这有时造成一些不便。最近发现x11vnc作为服务端似乎可以很顺利的安装使用，这次是在Deepin20上测试的，效果不错。

1. 安装x11vnc

   ```
   sudo apt install x11vnc
   ```

   

2. 密码设置

   ```
   x11vnc -storepasswd
   ```

   

3. 启动服务器

   ```
   x11vnc -rfbport 5900 -rfbauth ~/.vnc/passwd -display :0 -forever -bg -repeat -nowf -o ~/.vnc/x11vnc.log
   ```
### 启动失败解决方法
如果启动失败，log文件有如下提示：
```
** If NO ONE is logged into an X session yet, but there is a greeter login
   program like "gdm", "kdm", "xdm", or "dtlogin" running, you will need
   to find and use the raw display manager MIT-MAGIC-COOKIE file.
   Some examples for various display managers:

     gdm:     -auth /var/gdm/:0.Xauth
              -auth /var/lib/gdm/:0.Xauth
     kdm:     -auth /var/lib/kdm/A:0-crWk72
              -auth /var/run/xauth/A:0-crWk72
     xdm:     -auth /var/lib/xdm/authdir/authfiles/A:0-XQvaJk
     dtlogin: -auth /var/dt/A:0-UgaaXa

   Sometimes the command "ps wwwwaux | grep auth" can reveal the file location.

   Starting with x11vnc 0.9.9 you can have it try to guess by using:

              -auth guess

   (see also the x11vnc -findauth option.)

   Only root will have read permission for the file, and so x11vnc must be run
   as root (or copy it).  The random characters in the filenames will of course
   change and the directory the cookie file resides in is system dependent.
```
这似乎是因为桌面没有登陆的原因，首先查看管理的文件的位置，`ps -ef | grep auth`
```
root     30195  1.0  1.9 521724 78216 tty1     Ssl+ 14:42   0:00 /usr/lib/xorg/Xorg -background none :0 -seat seat0 -auth /var/run/lightdm/root/:0 -nolisten tcp vt1 -novtswitch
root     30270  0.0  0.5 572428 22160 ?        Sl   14:42   0:00 /usr/lib/deepin-daemon/dde-authority
```
可以看到管理文件的位置在`/var/run/lightdm/root/:0`，启动是加入-auth参数并指定文件位置即可
```
sudo x11vnc -rfbport 5900 -rfbauth ~/.vnc/passwd -display :0 -forever -bg -repeat -nowf -auth /var/run/lightdm/root/:0 -o ~/.vnc/x11vnc.log
```
如果查询不到或许是桌面环境没有启动，如在deepin20可尝试`sudo service lightdm start`启动桌面环境。

## VNC的配置与使用（Centos8、Ubuntu20测试）

文中使用的vncserver都是tigervncserver，不同的VNC使用都差不多，但是在xstart文件的配置可能有所不同，而且不同的桌面环境配置也不相同，下面使用的桌面环境都是Gnome。
1. **安装tigervnc**
   
    ```bash
    # CentOS
    sudo dnf install tigervnc-server
    # ubuntu 
    sudo apt install tigervnc-standalone-server
    ```
2. xstarup配置
下面两个配置，第一个只保留关键部分。
配置1，在CentOs及两个Ubuntu上测试，其中一个Ubuntu灰屏
    ```
    #!/bin/sh
    unset SESSION_MANAGER
    unset DBUS_SESSION_BUS_ADDRESS
    gnome-session &

    [ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
    [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
    xsetroot -solid grey
    vncconfig -iconic &
    ```
配置2，在CentOS测试，Ubuntu未测试
    ```
    #!/bin/sh

    unset SESSION_MANAGER
    unset DBUS_SESSION_BUS_ADDRESS
    OS=`uname -s`
    if [ $OS = 'Linux' ]; then
      case "$WINDOWMANAGER" in
        *gnome*)
          if [ -e /etc/SuSE-release ]; then
            PATH=$PATH:/opt/gnome/bin
            export PATH
          fi
          ;;
      esac
    fi
    if [ -x /etc/X11/xinit/xinitrc ]; then
      exec /etc/X11/xinit/xinitrc
    fi
    if [ -f /etc/X11/xinit/xinitrc ]; then
      exec sh /etc/X11/xinit/xinitrc
    fi

    [ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
    [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
    xsetroot -solid grey
    vncconfig -iconic &
    xterm -geometry 8024+10+10 -ls -title "$VNCDESKTOP Desktop" &
    twm &
    # gnome-session &
    gnome-session gnome
    ```
可能**需要重启**后才能正常使用。
3. **vncsever使用**
   vncserver中常用的命令就是`vncserver`

   ```bash
   # 开启一个端口
   vncserver :20 # 如 :20 指定端口号为20，
   # 停止一个端口
   vncserver -kill :20
   # 其他可选参数
   vncserver :22 -localhost no # -localhost设置是否为本地端口
   vncserver :22 -xstartup ./xstartup #指定xstartup文件
   ```

   

4. **访问远程桌面**
    使用VNC客户端，输入地址+端口就可以访问。如在realvnc中`192.168.194.236:22`
    由于tigervncserver默认使用本地端口，使用其他设备不能直接访问，可以在启动时加`-localhost no`参数指定端口可以让所有设备访问。
    
    ```bash
    ## 不使用 -localhost参数
    vncserver :22
    # 查看端口开放情况
     netstat -ano | grep 5922
    tcp        0      0 127.0.0.1:5922          0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp6       0      0 ::1:5922                :::*                    LISTEN      off (0.00/0/0)
    
    ## 使用 -localhost参数
    vncserver :22 -localhost no
    # 查看端口开放情况
    netstat -ano | grep 5922
    tcp        0      0 0.0.0.0:5922            0.0.0.0:*               LISTEN      off (0.00/0/0)
    tcp6       0      0 :::5922                 :::*                    LISTEN      off (0.00/0/0)
    ```
此外还可以使用ssh端口转发，或者使用iptables或firewall-cmd开发指定端口。
如：

    ```bash
    ### ssh端口转发，访问使用127.0.0.1:5922
    ssh -L 5922:127.0.0.1:5922 -N li@192.168.194.236
    ### firewall-cmd 开放端口
    firewall-cmd --permanent --zoon=public --add-port=5901/tcp
    # 或者端口范围
    firewall-cmd --permanent --zoon=public --add-port=5900-5999/tcp
    # 生效规则
    firewall-cmd --reload
    ```

## 后记
这个VNC是真滴玄学，都是Ubuntu20，都是tigervncserver，同样的xstartup文件，可是一个就可以正常，一个就是灰屏。灰屏的那个不使用xstartup能连接，但是锁屏后就不能输入密码解锁了。

在redhat（realVNC、tigerVNC）上可用的xstartup文件，

```shell
#!/bin/sh

[ -r /etc/sysconfig/i18n ] && . /etc/sysconfig/i18n
export LANG
export SYSFONT
vncconfig -iconic &
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
OS=`uname -s`
if [ $OS = 'Linux' ]; then
  case "$WINDOWMANAGER" in
    *gnome*)
      if [ -e /etc/SuSE-release ]; then
        PATH=$PATH:/opt/gnome/bin
        export PATH
      fi
      ;;
  esac
fi
if [ -x /etc/X11/xinit/xinitrc ]; then
  exec /etc/X11/xinit/xinitrc
fi
if [ -f /etc/X11/xinit/xinitrc ]; then
  exec sh /etc/X11/xinit/xinitrc
fi
[ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
xsetroot -solid grey
xterm -geometry 80x24+10+10 -ls -title "$VNCDESKTOP Desktop" &
twm &
```

同样的配置文件，在将虚拟机（RHEL 5）与主机（RHEL 6 + Vmware workstation）的共享目录作为用户目录时，使用VNC遇到灰屏问题，猜想或许时用户目录权限的问题，而且使用该用户在本机登陆桌面也不能成功登陆，会提示用户目录权限相关问题。



---

**参考**

1. [](#)

