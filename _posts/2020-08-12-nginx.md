---
title: NGINX配置
tag: ['nginx']
article_header:
  type: overlay
  theme: dark
  background_color: '#203028'
  background_image:
    gradient: 'linear-gradient(135deg, rgba(34, 139, 87 , .4), rgba(139, 34, 139, .4))'
    src: /assets/images/cover1.jpg
---

Nginx的配置，随需要更新。端口转发、HTTPS配置，IP访问设置

<!--more-->

## 端口转发

在主机上开启WEB服务通常使用的是非80端口，访问该服务时则需要加入相应端口如(`http://127.0.0.1:8088`)，通过nginx的端口转发功能可以实现直接使用`http://127.0.0.1`访问`8088`端口服务。功能的实现也十分简单，只需要在Nginx的配置文件server块添加相应设置即可,如： 

```shell
   server {
	    listen 80;
        server_name 127.0.0.1;
        location / {
            proxy_pass http://127.0.0.1:8088;
        }
    }
```

上面是基本的配置内容，也能看增加一些其他的设置（暂不清楚具体什么功用Orz）:

```
   server {
	    listen 80;
        server_name 127.0.0.1;
        location / {
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $http_host;
            proxy_set_header X-NginX-Proxy true;
            proxy_redirect off;
            proxy_pass http://127.0.0.1:8088;
        }
    }
```

## HTTPS配置

HTTPS默认使用443端口，所以需要让Nginx监听443端口，`ssl_certificate`指定证书路径，其使用的是`fullchain.pem`，而非'<domain>.pem'，`ssl_certificate_key`提供私钥的路径，关于证书的申请，可参考[SSL证书申请与配置certbot和acme.sh](./SSL证书申请)。同时将80端口也转发到443端口，强制使用https。[SSL证书申请与配置certbot和acme.sh]({% post_url 2020-09-10-SSL证书申请 %})

```yaml
 server {
     listen       443 ssl;
     listen       [::]:443 ssl;
     server_name  my.domain.com;
     # 配置ssl证书路径及其他设置
     ssl_certificate            /home/user/SSL/my.domain.com/fullchain.pem; # 证书
     ssl_certificate_key        /home/user/SSL/my.domain.com/key.pem; # 证书key
     ssl_session_cache shared:SSL:1m;
     ssl_session_timeout  10m;
     ssl_ciphers PROFILE=SYSTEM;
     ssl_ciphers PROFILE=SYSTEM;
     ssl_prefer_server_ciphers on;
     
    # 如果使用IP或其他域名访问重定向到https://my.domain.com
    if ($host != 'my.domain.com') {
       rewrite ^(.*) https://my.domain.com$request_uri? permanent;
       
     # 需要转发的服务
     location / {
         proxy_pass http://127.0.0.1:8001;
     }

     error_page 404 /404.html;
     location = /40x.html {
     }

     error_page 500 502 503 504 /50x.html;
         location = /50x.html {
     }
 }
server {
    listen       80;
    server_name  my.domain.com;
    # 将http重定向到https
    rewrite ^(.*)$ https://$http_host$1 permanent;
    # 如果使用IP或其他域名访问重定向到https://my.domain.com
    if ($host != 'my.domain.com') {
       rewrite ^(.*) https://my.domain.com$request_uri? permanent;
    }
}
```

## IP访问设置

### IP访问强制跳转域名

在server段内设置:

```shell
if ($host != 'my.domain.com') {
    rewrite ^(.*) https://my.domain.com$request_uri? permanent;
}
```



## 问题及解决

###  502 Bad Gateway

在CentOS8上按如上配置使用，出现了`502 Bad Gateway`错误，查看`/var/log/nginx/error.log`发现，有Permission denied错误

```
2020/08/12 15:50:30 [crit] 624160#0: *1 connect() to 127.0.0.1:8088 failed (13: Permission denied) while connecting to upstream, client: 192.1.2.1, server: 127.0.0.1, request: "GET / HTTP/1.1", upstream: "http://127.0.0.1:8001/", host: "192.1.2.145"
```

查找资料发现是SElinux的问题，根据[Stack overflow](https://stackoverflow.com/questions/23948527/13-permission-denied-while-connecting-to-upstreamnginx)上的回答修改Selinux的设置，后问题解决。

```shell
sudo setsebool -P httpd_can_network_connect 1
```

### 开机自启

```
sudo systemctl enable nginx
```



---

**参考**

1. [title](url)

[nginx配置url重写 - 前端小武的博客](https://xuexb.com/post/nginx-url-rewrite.html)