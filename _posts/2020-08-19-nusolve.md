$\nu$Solve软件包从0.5及以后的版本，包含**$\nu$Solve**、**vgosDbMake**、**vgosDbCalc**和**vgosDbProcLogs**四个程序。
vgosDbMake 从条纹文件中提取数据，并创建一个vgosDb数据集文件(The utility vgosDbMake extracts some data from fringe files and creates a vgosDb set of files for a VLBI session)。  
vgosDbCalc 计算理论值和偏导数，并以vgosDb形式存储数据(vgosDbCalc calculates theoretical values and partials, stores these information in the vgosDb format)。  
vgosDbProcLogs 从测站站日志文件中提取其他信息（电缆校准和气象参数），并将其添加到vgosDb数据集中(The utility vgosDbProcLogs extracts additional information (cable calibration and meteorological parameters) from stations log files and adds it to a vgosDb set of files.)。

[toc]

## 软硬件需求
该软件对于硬件无特殊要求，现代通用计算机都可以运算。软件在Linux系统上开发，可以兼容任何POSIX系统。此外还需要Qt、netCDF以及HOPS（可选，vgosDbMake需要）运行库的支持。

## 安装基础开发环境gcc、g++、gfotran、make
同一个软件在不同发行版本下可能使用不同的软件包名称，安装时会有所不同。
1. CentOS  
CentOS中的安装命令`yum`在CentOS 8 也可以使用`dnf`。
```
sudo yum make gcc gcc-c++ gcc-gfortran
```
2. Debian
```
sudo apt install make gcc g++ gfortran
```

## 依赖软件的安装
目前各linux发行版本的软件仓库中通常都包含Qt及netCDF相关软件包可供安装，HOPS可以从Haystack的FTP站点下载（ftp://gemini.haystack.mit.edu/pub/hops/ ）。所以除HOPS需要编译安装外，其他都可以比较方便的从各Linux发行版本的软件库中安装。

### Qt
从0.7.1版本之前的版本仅支持Qt4，0.7.1及之后可以使用Qt4或Qt5进行编译安装（不过在安装过程中发现0.7.1使用Qt5或Qt4均有问题）

如无使用进行程序Qt开发的需求**推荐直接从软件仓库安装Qt环境即可**

#### 从软件仓库安装
1. CentOS（以下使用的命令在CentOS 8及 CentOS7验证）
```
sudo yum install qt5-qtbase-devel qt5-qtbase
```
如果不放心也可使用`qt5-qtbase*`安装所有qt5-base相关组件，在CentOS官方源中似乎没有qt4。

2. Debina (Debina 10及Ubuntu20测试)
```
qt4-default
qt5-default
```

#### 源码安装

Qt各版本的安装文件及源码可以在这里下载：https://download.qt.io/archive/qt/ 其中有些版本会提供安装程序（\*.run）也可直接使用安装程序安装。
源码下载解压后，进入源码目录下，安装基本可分为三步：
- 生成Makefile文件 `./configure`
- 编译程序 `make`
- 安装 `make install`
第一步中可以指定如一些参数，如 `--prefix=/opt/qt`指定qt安装的路径为`/opt/qt`；`-opensource`参数指定使用开源许可等，其他参数可以使用`./configure --help`。另外在安装过程中可能会在第一、二步遇到一些错误，通常为缺失依赖库，可根据提示进行安装或指定依赖库的路径。**搜索引擎（[百度](https://www.baidu.com)、[Google](https://www.google.com)）是个好东西**。
下面有几个我安装过程中遇到的问题及解决方法，可做参考：
1. 安装Qt5时遇到:ERROR: The OpenGL functionality tests failed!
	```
	ERROR: The OpenGL functionality tests failed!
	You might need to modify the include and library search paths by editing QMAKE_INCDIR_OPENGL[_ES2],
	QMAKE_LIBDIR_OPENGL[_ES2] and QMAKE_LIBS_OPENGL[_ES2] in the mkspec for your platform.
	```
	**解决方法**：  
	在CentOS上，安装需要的依赖库`sudo dnf install mesa-libGL-devel mesa-libGLU-devel -y`，之后`rm config.cache`删除configure记录，重新运行configure。

2. 安装Qt5遇到：error: one or more PCH files were found, but they were invalid
	```
	cc1plus: error: one or more PCH files were found, but they were invalid
	cc1plus: error: use -Winvalid-pch for more information
	cc1plus: fatal error: .pch/release-shared/Qt5Core: No such file or directory
	compilation terminated.
	```
	**解决方法**：  
	执行configure命令时添加`-no-pch`参数。

3. 提示没有python命令
	目前新发行的系统中默认只有python3.6，可以使用建立软链接的方式将python命令指向python3如：
	```
	ln -s /usr/bin/python3.6 /usr/bin/python
	```
	为python3增加一个python别名应该也可以`alias python=python3`。

### netCDF
1. CentOS(以下使用的命令在CentOS 8及 CentOS7验证)
```
sudo dnf install zlib-devel.x86_64  #已安装
sudo dnf install epel-release-8-8.el8.noarch  -y #安装扩展源，扩展源有hdf5
sudo dnf install hdf5-devel #安装hdf5
sudo dnf install netcdf-devel.x86_64 # 安装netcdf
```
如果安装hdf5-devel是提升无法安装libaec可尝试下面的命令
```
sudo dnf --enablerepo=PowerTools install libaec-devel 
```
########
测试一下直接安装netcdf会不把他的依赖软件也自动安装
########

2. Debian
```
sudo apt install libhdf5-dev libnetcdf-dev
```
这里安装的zlib、hdf5、netcdf也都可使用源码安装，安装过程与Qt基本相似。
netCDF源码可以从这里下载：ftp://ftp.unidata.ucar.edu/pub/netcdf/

### HOPS
如果需要编译vgosDbMake，需要安装HOPS，下载地址：ftp://gemini.haystack.mit.edu/pub/hops/
HOPS通过源码安装，过程与Qt源码安装类似：
- 安装HOPS依赖库：gplot可从 https://pkgs.org/ 查询不同发现版本系统对应的软件包名称。
如CentOS 8需要的软件包为：pgplot-devel-5.2.2-47.el8.x86_64.rpm

![dMtcnK.png](https://s1.ax1x.com/2020/08/18/dMtcnK.png)

详情页可是看到安装方法(Install Howto)：
>1. Download latest rpmfusion-nonfree-release rpm from:
>http://download1.rpmfusion.org/nonfree/el/updates/testing/8/x86_64/
>2. Install rpmfusion-nonfree-release rpm:
>`# rpm -Uvh rpmfusion-nonfree-release*rpm`
>3. Install pgplot-devel rpm package:
>`# dnf install pgplot-devel`

进入HOPS源码目录，新建build目录并进入该目录，然后依次执行：
```shell
../hops-3.21/configure --prefix=$HOME/hops # 指定安装目录为用户目录下的hops目录内
 make install
```
**详细内容可查看README文件**。

## $\nu$Solve安装
nuSolve可以从[sourceforge](https://sourceforge.net/projects/nusolve/)下载源码安装。
同样安装可以分为三步（进如源码目录）：
- 生成Makefile文件 `./configure`
- 编译程序 `make`
- 安装 `make install`
注意，第一步中，如果前面有通过源码安装的依赖且安装在非默认安装位置，同样需要相应的参数来指定所需要的库及头文件的位置。如：
```shell
--with-qt-dir=[PATH_TO_QT-4.8] # 指定Qt安装目录
# 如果Qt的库没有放置在安装目录下，还需要下面参数分别给出
--with-qt-include =[PATH_TO_QT-4.8 includes]
--with-qt-lib=[PATH_TO_QT-4.8 libraries]
--with-qt-bin=[PATH_TO_QT-4.8 binaries (the utility 'moc')]
```
指定netCDF位置
```shell
--with-netcdf-include =[PATH_TO_NETCDF includes]
--with-netcdf-lib=[PATH_TO_NETCDF libraries]
```
**默认是不编译vgosDbMake的，如需编译则应给出HOPS文件路径**：
```shell
--with-hops-dir=[PATH_TO_HOPS]
# 或者
--with-hops-include=[PATH_TO_HOPS include files]
--with-hops-lib=[PATH_TO_HOPS libraries]
--with-hops-share=[PATH_TO_HOPS shared data]
```

### 安装遇到的问题及解决

1. 编译错误：error: '::malloc' has not been declared

	```
	In file included from /usr/include/c++/8/ext/string_conversions.h:41,
	                 from /usr/include/c++/8/bits/basic_string.h:6400,
	                 from /usr/include/c++/8/string:52,
	                 from /usr/include/c++/8/bits/locale_classes.h:40,
	                 from /usr/include/c++/8/bits/ios_base.h:41,
	                 from /usr/include/c++/8/ios:42,
	                 from /usr/include/c++/8/ostream:38,
	                 from ./Sg3dVector.h:35,
	                 from Sg3dVector.cpp:23:
	/usr/include/c++/8/cstdlib:151:11: error: '::malloc' has not been declared
	   using ::malloc;
	           ^~~~~~
	make[2]: *** [Makefile:790: Sg3dVector.lo] Error 1
	make[2]: Leaving directory '/home/vgos/csfile/dir/nusolve-0.7.1/src/SgLib'
	make[1]: *** [Makefile:579: all-recursive] Error 1
	make[1]: Leaving directory '/home/vgos/csfile/dir/nusolve-0.7.1'
	make: *** [Makefile:413: all] Error 2
	```

	**解决方法**：  
	这个问题通常发生在netcdf没有安装在默认位置，系统不能自动寻找到所需要的库文件，可以使用`LD_LIBRARY_PATH`指定netcdf库的位置：
	```
	export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$HOME/local/netcdf/lib
	./configure --prefix=/usr  --with-netcdf-include=$HOME/local/netcdf/include --with-netcdf-lib=$HOMElocal/netcdf/lib #重新生成Makefile
	make
	```
	参考：http://104.197.24.192/unstumping-the-internet/malloc-has-not-been-declared/#rootcause

2. 编译过程中找不到文件- error: QtCore/QString: No such file or directory 

	```
	SgMatrix.cpp:25:10: fatal error: QtCore/QString: No such file or directory
	 #include <QtCore/QString>
	          ^~~~~~~~~~~~~~~~
	compilation terminated.
	make[2]: *** [Makefile:790: SgMatrix.lo] Error 1
	make[2]: Leaving directory '/home/test/Downloads/nusolve-0.7.1/src/SgLib'
	make[1]: *** [Makefile:579: all-recursive] Error 1
	make[1]: Leaving directory '/home/test/Downloads/nusolve-0.7.1'
	make: *** [Makefile:413: all] Error 2
	```
	**解决方法**：
	查找文件路径手动指定
	```
	./configure --prefix=$HOME/ns --with-qt-include=/usr/include/qt5 --with-qt-dir=/usr/include/qt5
	```

3. 编译过程中找不到moc命令
	```
	/usr/bin/moc SgGuiLogger.h -o SgGuiLogger.moc.cpp
	make[2]: /usr/bin/moc: Command not found
	make[2]: *** [Makefile:994: SgGuiLogger.moc.cpp] Error 127
	make[2]: Leaving directory '/home/test/test/nusolve-0.7.0/src/SgLib'
	make[1]: *** [Makefile:526: all-recursive] Error 1
	make[1]: Leaving directory '/home/test/test/nusolve-0.7.0'
	make: *** [Makefile:395: all] Error 2
	```
	**解决方法**：
	确认moc位置，使用MOC参数手动指定如：
	```
	./configure --prefix=$HOME/ns  MOC='/usr/local/Trolltech/Qt-4.8.7/bin/moc'
	```
4. 使用Qt5编译nuSolve 0.7.1时遇到的编译错误
	```
	/bin/sh ../../libtool  --tag=CXX   --mode=compile g++ -DHAVE_CONFIG_H -I. -I../..  -I/Qt5.12.0/5.12.0/gcc_64/include -I/home/test/local/netcdf/include    -Wall -W -Wpointer-arith -Wcast-align -Wredundant-decls -DDEBUG -g -ggdb -O3 -fopenmp -g -Wall -W -Wpointer-arith -Wcast-align -Wredundant-decls -DDEBUG -MT SgMatrix.lo -MD -MP -MF .deps/SgMatrix.Tpo -c -o SgMatrix.lo SgMatrix.cpp
	libtool: compile:  g++ -DHAVE_CONFIG_H -I. -I../.. -I/Qt5.12.0/5.12.0/gcc_64/include -I/home/test/local/netcdf/include -Wall -W -Wpointer-arith -Wcast-align -Wredundant-decls -DDEBUG -g -ggdb -O3 -fopenmp -g -Wall -W -Wpointer-arith -Wcast-align -Wredundant-decls -DDEBUG -MT SgMatrix.lo -MD -MP -MF .deps/SgMatrix.Tpo -c SgMatrix.cpp  -fPIC -DPIC -o .libs/SgMatrix.o
	libtool: compile:  g++ -DHAVE_CONFIG_H -I. -I../.. -I/Qt5.12.0/5.12.0/gcc_64/include -I/home/test/local/netcdf/include -Wall -W -Wpointer-arith -Wcast-align -Wredundant-decls -DDEBUG -g -ggdb -O3 -fopenmp -g -Wall -W -Wpointer-arith -Wcast-align -Wredundant-decls -DDEBUG -MT SgMatrix.lo -MD -MP -MF .deps/SgMatrix.Tpo -c SgMatrix.cpp -o SgMatrix.o >/dev/null 2>&1
	```
	**解决方法**：  
	未找到解决方法，怀疑是程序bug。
5. 使用Qt4编译nuSolve 0.7.1只有nuSolve程序可以正常使用，其他程序的图形界面无法打开。
	如运行vgosDbCalc，图形界面打不开，但是其命令可以使用。
	```
	$ ./vgosDbCalc
	QWidget: Must construct a QApplication before a QPaintDevice
	Aborted (core dumped)

	$ ./vgosDbCalc -v
	This is:
	   vgosDbCalc-0.4.1 (Lake Marian) released on 19 May, 2020
	   SgLib-0.7.1 (Linganore Creek) released on 19 May, 2020

	```

	**解决方法**：  
	未找到解决方法，怀疑是程序bug。
## 程序打包（Appimage）

为了能够方便的在其他设备上安装运行程序，将程序整合为一个可独立运行的软件包是很必要的，目前linux系统上有snap、appimage、Flatpak等多种软件打包格式，这里选择Appimag的方式。打包后的程序可以在当前系统版本或更新版本上直接运行使用。关于Appiamge的详细信息可参见[官方文档](https://docs.appimage.org/introduction/index.html)。

使用使用打包工具linuxdeploy辅助打包，linuxdeploy的[下载地址](https://github.com/linuxdeploy/linuxdeploy/releases)及[使用帮助](https://docs.appimage.org/packaging-guide/from-source/linuxdeploy-user-guide.html)。
安装方法与之前基本相同，区别在于指定安装目录为`/usr`即`./configure --prefix=/usr`，在执行`make install`安装是需要增加`DESTDIR`参数，如`make install DESTDIR=$HOME/AppDir`即将程序安装到用户目录下的AppDir文件夹内。
此时安装目录的结构为：
```
-AppDir
  - usr
    - bin # 可执行程序
    - lib # 依赖库文件
    - share # 其他文件，如用户手册等
```
然后使用linuxdeploy将依赖库文件复制到lib目录下：
```
./linuxdeploy-x86_64.AppImage --appdir $HOME/AppDir
```
这样，基本算打包完成了。将AppDir目录整个复制到其他设备即可直接使用。